<h1 align="center">mod_ndb</h1>

<h2>Introduction</h2>
<P>Mod_ndb is an Apache module that provides a REST web services API for MySQL Cluster, making it possible to query and modify a database over HTTP using GET, POST, and DELETE requests.  An Apache web server running mod_ndb can join a MySQL Cluster as an API node and communicate directly with the cluster's data storage nodes, possibly eliminating the &quot;middle tier&quot; MySQL server from a web architecture.</p>
	
<P>The primary intent behind mod_ndb is to provide the performance benefits of direct access to NDB in a way that is significantly easier to use than the call-level NDB API.  It is also designed to interact directly with embedded Web application languages like PHP, Perl, and Ruby using Apache subrequests, and to correctly interact with HTTP 1.1 caches and proxy servers.


<h2>A Quick Example</h2>

<p>A simple example can illustrate how mod_ndb might be used with MySQL Cluster.</p>
	
<h3>1: Cluster configuration</h3>

<p>Each Apache proces that joins the cluster will connect to the cluster management server and obtain a Node ID.  (Note that there is always a limit on the total number of nodes in a cluster, and because of this it may be best to run mod_ndb under a multi-threaded MPM in Apache 2.)  In the cluster configuration file, you will need to define an API node for each Apache process.  Empty &quot;[API]&quot; sections are sufficient for this, as follows: <BR>
	
<pre>
[API]
[API]
[API]
</pre>
	
<h3>2: Table creation</h3>

A demonstration table can be created from a MySQL server.

<pre>
CREATE DATABASE mod_ndb_test;
USE mod_ndb_test;
CREATE TABLE cars (
   id INT NOT NULL PRIMARY KEY,
   make varchar(16) not null,
   model varchar(16),
   license_tag varchar(8),
   photo blob,
   index tag_idx (license_tag)
) engine=ndbcluster;
</pre>

<h3>3: Configuration, requests, and responses</h3>

<p>The majority of the information used to process and execute a request in mod_ndb is maintained in the Apache configuration file.  Mod_nbd's configuration is similar to the 
PREPARE phase of many SQL APIs, when a developer can prepare a statement for execution and bind parameters to its variables.  Later, the HTTP request, like the SQL EXECUTE phase, provides values for the named parameters.  </p>

<p>The following except from httpd.conf illustrates some ways to use the cars table.</p>

<pre>

LoadModule ndb_module         mod_ndb.so
AddModule mod_ndb.cc
	
ndb-connectstring = my_mgm_server

&lt;Location /ndb&gt;
   SetHandler ndb-cluster
   Database mod_ndb_test
&lt;/Location&gt;

&lt;Location /ndb/car/&gt;
   Table cars
&lt;/Location&gt;

&lt;Location /ndb/car/by_id&gt;
   PrimaryKey id
   Columns id make model license_tag
   PathInfo id 
   Format JSON
&lt;/Location&gt;
     
&lt;Location /ndb/car/photo&gt;
   PrimaryKey id
   OrderedIndex tag_idx license_tag
   Pathinfo license_tag
   Columns photo
   Format raw
   DefaultType image/jpeg
&lt;/Location&gt;
</pre>

<p>LoadModule and AddModule are used as with other Apache modules to load mod_ndb into the server.  The subsequent ndb-connectstring directive indicates the location of the cluster management server .</p>

<p>The remaining sections create a hierarchy of URLs and describe how mod_ndb should generate response pages for them.  The directive <B>SetHandler ndb-cluster</B> applies to all URLs beginning with /ndb.  The subsequent <b>Database</b> and <strong>Table</strong> directives ensure that every URL under /ndb refers to tables in the database <em>mod_ndb_test</em> and that location unders /ndb/car use the cars table.   </p>

<p>At any given URL, users do not have complete or arbitrary access to an NDB table, but only the access explicitly allowed in the configuration file.  The  <strong>PrimaryKey</strong>, <strong>UniqueIndex</strong>, and <strong>OrderedIndex</strong> directives enable queries using particular indexes.  The <strong>Columns</strong> directive defines the list of columns that will be returned in a GET request, while <strong>AllowUpdate</strong> specifies the columns that can be modified in an HTTP POST.  HTTP DELETE requests are allowed only if an explicit <strong>Deletes On</strong> directive enables them. </p>

<p>At /ndb/car/by_id, the file specifies "PrimaryKey id," which enables mod_ndb to respond to a request like /ndb/car/by_id?id=7 with the a row of results from the database.  The additional line specifying "PathInfo id" maps the rightmost component of the URL to the id column, so that /ndb/car/by_id/7 will retrieve the same row.  The result row will be returned in JSON format.</p>

<p>Under the final configuration section, at /ndb/car/photo, only the BLOB column <em>photo</em> is returned, without any additional formatting.  The <strong>DefaultType image/jpeg</strong> directive (which is handled by <em>mod_mime,</em> not mod_ndb) sets the MIME type of the response appropriately.  Photos can be obtained using the primary key (/ndb/car/photo?id=3), the license number as an argument (/ndb/car/photo?license_tag=abc+123), or the license number as a part of the URL (/ndb/car/photo/abc+123).</p>
	


<h2>Configuring mod_ndb</h2>

<h3>Request Handlers</h3>

<p>mod_ndb defines three possible request handlers which can be specified using Apache's SetHandler directive.
	
	<dl>
	<dt><strong>ndb-cluster</strong></dt>
	<dd>The primary handler.  Enables mod_ndb to respond to HTTP requests by querying the NDB data nodes as specified in the Apache configuration file.</dd>
	<dt><strong>ndb-config-check</strong></dt>
	<dd>Povides output that explains how mod_ndb has processed its configuration file, and may be useful for debugging configuration problems.</dd>
	<dt><strong>ndb-status</strong></dt>
	<dd>Provides runtime statistics on mod_ndb's performance <i>(not yet usable in this release)</i>.
	</dl>

<h3>Per-server configuration</h3>

<dl>
	<dt><strong>ndb-connectstring</strong></dt>
	<dd>NDB connection string; refer to <a href="http://dev.mysql.com/doc/refman/5.0/en/mysql-cluster-connectstring.html">http://dev.mysql.com/doc/refman/5.0/en/mysql-cluster-connectstring.html</a> for details.</dd>
</dl>

<h3>Per-directory configuration </h3>

<h4>Common directives</h4>

<p>The Database, Table, Columns, AllowUpdate, and Format directives supply basic information on how mod_ndb should behave.  These parameters can be inherited down the directory tree, as illustrated in the example above, where <b>Database mod_ndb_test</b> and <b>Table cars</b> apply to every section, including <i>/ndb/car/by_id</i> and <i>/ndb/car/photo</i>, though they are specified only once.
	
<dl>
	<dt><strong>Database</strong><dt>
	<dd>Specifies the MySQL database used in queries</dd>
	
	<dt><strong>Table</strong><dt>
	<dd>Specifies the table for a specific directory </dd>
	
	<dt><strong>Columns</strong><dt>
	<dd>Specifies the list of columns (separated by white space) to be returned in the result set.  These are actual column names in the table structure, not the column aliases, as described below, used for the request parameters.</dd>
	
	<dt><strong>AllowUpdate</strong><dt>
	<dd>Specifes the list of columns (separated by white space) that may be updated by a POST query.  Any parameters that are supplied in the POST request but are not in this list will be ignored  </dd>
	
	<dt><strong>Format</strong><dt>
	<dd>Specifies the output format used for the response.  The supported formats are:
		<ul>
			<li> <B>JSON</b> --  Results are formatted in Javascript Object Notation, as described at <a href="http://www.json.org/">http://www.json.org</a>.  This is the default output format.
			<li> <B>XML</b>  --  <i>XML output format is accepted in the configuration file, but XML output is not currently supported. </i>
			<li> <B>Raw</b> --  results are not formatted or structured in any way, but the literal value of a single column is sent as the response.  When raw results are used, only a single column may appear in the output.  This is most useful with BLOB or TEXT columns.  A mod_mime DefaultType directive should be used to set the MIME type of the output approriately, as illustrated in the example above.   
			<li> <B>ApacheNote</b>.  Results are not actually sent to the browser at all, but set as notes in apache's internal notes table.  If mod_ndb is called as an Apache sub-request (using PHP's <em>virtual()</em> function, for example), notes are set in the parent request's notes table; otherwise they are set in the mod_ndb request's own table.  By default, a note is created for each column name in the <em>Columns</em> list, where the column name is the name of the note, and the column value is the value of the note.  This format is only useful for single-row responses from PrimaryKey or UniqueIndex queries.  Alternately, if the optional argument to this format is set to either <em>JSON</em> or <em>Raw</em>, then a single note is created; the name of this note is <em>NDB_results</em>, and its value is the complete response in the format specified by the argument.  This option can be used for multi-row responses generated by OrderedIndex scans.
			</ul>
</dd>
	<dt><strong>ETags</strong></dt>
	<dd>A flag which can be set to On or Off.  With ETags On, mod_ndb will compute an MD5 fingerprint of the response and send an ETag header containing the fingerprint.  It will also respond appropriately to &quot;If-match&quot; and &quot;If-none-match&quot; conditional requests from caches and proxy servers.  If Etags is set to Off, the MD5 checksum will not be computed, and conditional requests will be treated as normal requests.  The default is ETags On.  </dd>
	<dt><strong>Deletes</strong></dt>
	<dd>A flag, set to either On or Off, indicating whether HTTP DELETE requests should be accepted.  The default is Deletes Off.  This directive cannot be inherited in the directory hierarchy; it must be specified independently for each directory where deletes are allowed.</dd>
</dl>
<h4>Directives specifying data access plans</h4>

<dl>
	<dt><strong>PrimaryKey</strong><dt>
	<dd>Allows primary key access to a table. 
	 <br>
		Format:  PrimaryKey <em>column_alias [ column_alias ...] </em><br>
		Example:  PrimaryKey car_id
	</dd>
	
	<dt><strong>UniqueIndex</strong><dt>
	<dd>Allows access to a table using a specific unique index.
		<br>
		Format:  UniqueIndex <em>indexname column_alias [ column_alias ...]  </em><br>
		Example: UniqueIndex name$unique name <br>
	</dd>
		
		
	<dt><strong>OrderedIndex</strong><dt>
	<dd>Allows access to a table using a specific ordered index.  Unlike lookups on primary keys and unique indexes, an ordered index scan can return multiple result rows. The column list can also include a sort flag, one of <tt>[ASC]</tt>
or <tt>[DESC]</tt>, which will cause results to be returned in sorted order.  (Note that unsorted scans can be parallelized, and may perform faster than sorted ones).
		<br>
		Format:  OrderedIndex <em>indexname column_alias [ column_alias ...] [ sort_flag ]</em><br>
		Example: OrderedIndex license_tag license_tag <br> 
	</dd>
	
</dl>

<p>The PrimaryKey, UniqueIndex, and OrderedIndex directives define access paths
for HTTP requests against a table.  PrimaryKey refers to NDB's unique hash 
primary key (sometimes called the distribution key), which is present for every
table.  The UniqueIndex and OrderedIndex directives require you to supply the
name of the index as it is known to NDB.  Note that this often differs from the 
index name in MySQL in several ways</p>
<ul>
	<li>A MySQL primary key usually corresponds to two separate keys in NDB: the 
		unique hash distribution key (PrimaryKey) and an OrderedIndex named
		PRIMARY. </li>
	<li>A unique index in MySQL usually corresponds to an NDB UniqueIndex 
		with a name ending in <em>$unique</em>.
	<li>Other MySQL indexes are usually represented by a pair of NDB indexes.
		For instance, a MySQL index named &quot;icon_id&quot; corresponds to 
		an OrderedIndex named icon_id and a UniqueIndex named icon_id$unique.
</ul>

<p>MySQL's &quot;SHOW CREATE TABLE&quot; and &quot;SHOW INDEXES&quot; statements
will reveal a table's index structure as seen by MySQL, and the command-line utility
<em>ndb_desc</em> can reveal the index names used by NDB.</p>

<p>PrimaryKey lookups are the most efficient data access path.  OrderedIndex 
scans can return multiple rows of results.</p>

<p>While the supplied index names must match NDB's actual indexes, the <em>column_alias</em> names do <b>not</b> need to correspond to actual column names. 
A directive like <br>
<pre>

	PrimaryKey i j
</pre>	

is interpreted so that the HTTP parameter <em>i</em> is mapped to the first column of
a two-part primary key, and <em>j</em> is mapped to the second part of the key.  It makes no difference whether the two parts of the primary key are actually columns named 
<em>i</em> and <em>j</em> or if they are named something else, say <em>user_id</em> and <em>icon_id</em>.

<dl>	
	<dt><strong>Filter</strong><dt>
	<dd>Used to set bounds other than equality on ordered index scans, or to add an NdbScanFilter to a scan.  Not yet documented.</dd>
	
	<dt><strong>PathInfo</strong><dt>
	<dd>Used to implicitly associate key columns (which must be named elsewhere in a PrimaryKey, UniqueIndex, OrderedIndex, or Filter directive) with the rightmost parts of the URL path name.<br>
		Format: PathInfo <em>key_col/key_col/... </em> <br>
		Example: PathInfo user_id/icon_id <br>
	</dd>
	
</dl>
	
<h4>How access plans are selected at runtime</h4>

<p>The Apache configuration file should associate each <em>column_alias</em> with 
	only a single index.  If the same column alias is used for multiple indexes, 
	the second instance will overwrite the first, and mod_ndb will write a line 
	(at log level <i>error</i>) to Apache's error log to note that it is 
	 &quot;Reassociating column.&quot;</p>
<p>In essence, whatever column aliases are used in the HTTP request determine the 
	access path for the request.  An indexed column in MySQL might belong to both 
	a UniqueIndex and an OrderedIndex in NDB; in mod_ndb, you choose one access path
	or the other using two different column aliases.
	  
	