#!/bin/sh

APXS=`which apxs`
APXS1=`which apxs`
MYSQLCFG=`which mysql_config`
GET_LIBS='--libs'
CONFIG_CMD="$0 $@"

usage() {
  echo
  echo "Building mod_ndb requires an installed copy of MySQL, including "
  echo "NDB Cluster, libraries header files, and the mysql_config utility, "
  echo "plus an installed copy of Apache including apxs. "
  echo 
  echo "Options:  "
  echo "       --mysql=/path/to/mysql_config "
  echo "       --apxs=/path/to/apxs "
  echo "       --apxs1=/path/to/apache13/apxs"
  echo "       --thread-safe"
  echo "       --aprconfig=/path/to/apr-config"
  echo 
  echo "To build an Apache 2 module, you must use apxs from *both* apache 1.3 and 2:"
  echo "  $0 --apxs=/apache/2/apxs --apxs1=/apache/1.3/apxs "
  echo
  echo "Defaults: --mysql=$MYSQLCFG --apxs=$APXS --apxs1=$APXS"
  echo 
  echo "Use --thread-safe if you have a thread-safe mysql client library."
  echo "If your apr is installed outside of apache2, use --aprconfig."
  echo
}


while test $# != 0
do
  case $1 in
   --*=*)
    conf_option=`expr "x$1" : 'x\([^=]*\)='`
    conf_arg=`expr "x$1" : 'x[^=]*=\(.*\)'`
    shift
    ;;
   *)
    conf_option=$1
    shift
    ;;
  esac
  
  case $conf_option in 
    --mysql)
      MYSQLCFG=$conf_arg
      ;;
    --apxs)
      APXS=$conf_arg 
      ;;
    --apxs1)
      APXS1=$conf_arg
      ;;
    --thread-safe)
      GET_LIBS='--libs_r'
      ;;
    --aprconfig)
      APRCONFIG=$conf_arg
      ;;
    --help)
      usage
      exit
      ;;
    *)
      echo "Unrecognized option " $conf_option
      exit
      ;;
  esac
done

## Check the Apache version
HTTPD=`$APXS -q SBINDIR`/`$APXS -q TARGET`
$HTTPD -v
if $HTTPD -v | grep -q "Apache/1.3" 
 then 
  MOD_SOURCE=mod_ndb_ap13.cc
  echo "Using Apache 1.3"
  APXS1=$APXS
 else 
  MOD_SOURCE=mod_ndb_ap20.cc
  echo "Using Apache 2"
fi
echo

echo "Configuring with"
echo "    apxs =         " $APXS 
echo "    apxs 1.3 =     " $APXS1
echo "    mysql_config = " $MYSQLCFG 
[ -n "$APRCONFIG" ] && echo "    apr-config =   " $APRCONFIG
echo "    libs         = " $GET_LIBS
echo

if [ ! -x "$APXS" ]
 then 
  echo "Error: apxs path is not valid."  && usage && exit 1
fi
if [ ! -x "$APXS1" ]
 then
   echo "Error: apxs1 path is not valid.  (Apache 1.3 apxs is also required)"
fi
if [ ! -x "$MYSQLCFG" ] 
 then
  echo "Error: mysql_config path is not valid." && usage && exit 1
fi
if [ -x "$APRCONFIG" ]
 then
  APRLD=`$APRCONFIG --ldflags`
  APRINC=`$APRCONFIG --includes`
fi
 
MY_INC=`$MYSQLCFG --include`
MY_LIBS=`$MYSQLCFG $GET_LIBS`

if $MYSQLCFG --version | grep -q '^5.1.' 
 then NDB_PATH=storage/ndb 
 else NDB_PATH=ndb 
fi


(
echo '#' Makefile for mod_ndb.  Automatically generated from:
echo '#' $CONFIG_CMD
echo
echo APXS=$APXS
echo MOD_SOURCE=$MOD_SOURCE
echo
echo MY_INC1=$MY_INC
echo MY_INC2=$MY_INC/$NDB_PATH
echo MY_INC3=$MY_INC/$NDB_PATH/ndbapi
echo MY_LIBS=$MY_LIBS
echo 
echo APXS_INCLUDEDIR=`$APXS -q INCLUDEDIR` $APRINC
echo APXS_SYSCONFDIR=`$APXS -q SYSCONFDIR`
echo APXS_LD_SHLIB=`$APXS1 -q LD_SHLIB` $APRLD
echo APXS_CFLAGS=`$APXS1 -q CFLAGS`   
echo APXS_CFLAGS_SHLIB=`$APXS1 -q CFLAGS_SHLIB`   
echo APXS_LDFLAGS_SHLIB=`$APXS1 -q LDFLAGS_SHLIB`
echo APXS_LIBS_SHLIB=`$APXS1 -q LIBS_SHLIB`

) > Makefile


cat make_file_tail >> Makefile

echo "Created Makefile."
echo
echo "Removing out-of-date files:"
make clean
echo
echo "Hello!  Run 'make' to build mod_ndb."
